<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Shopee圖片標記/商品資訊統計工具</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    #main { display: flex; gap: 20px; align-items: flex-start; width: 98%; margin-left: 1%; }
    #canvasWrapper { overflow: auto; border: 1px solid #ccc; }
    canvas { display: block; cursor: crosshair; }
    #itemSelector { margin-bottom: 10px; }
    #itemSelector button {
      margin: 0 5px;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
      color: white;
      border: none;
      border-radius: 3px;
    }
    #itemSelector button.active { border: 2px solid #000; opacity: 1; }
    #itemSelector button:not(.active) { opacity: 0.7; }
    #list {
      flex: none;
      width: 35%;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      margin-left: 5%;
    }
    #controls { margin-bottom: 10px; }
    #imageUpload { display: none; }
    table { border-collapse: collapse; table-layout: fixed; width: 100%; }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      word-wrap: break-word;
    }
    th:nth-child(1), td:nth-child(1) { width: 16%; }
    th:nth-child(2), td:nth-child(2) { width: 24%; }
    th:nth-child(3), td:nth-child(3) { width: 15%; }
    th:nth-child(4), td:nth-child(4) { width: 15%; }
    th:nth-child(5), td:nth-child(5) { width: 30%; }
    .total-row { font-weight: bold; background: #f0f0f0; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="imageUpload" accept="image/*">
    <button onclick="document.getElementById('imageUpload').click()">📁 上傳圖片或拖曳圖片至下方區域</button>
    <button onclick="clearAllMarks()">清除所有標記</button>
    <button onclick="exportToExcel()">匯出成 Excel</button>
    <button onclick="downloadImage()">下載標記後圖片</button>
  </div>

  <div id="itemSelector">
    <span>選擇品項後進行標記：</span>
    <button data-item="1" class="active">1</button>
    <button data-item="2">2</button>
    <button data-item="3">3</button>
    <button data-item="4">4</button>
    <button data-item="5">5</button>
    <button data-item="6">6</button>
    <button data-item="7">7</button>
    <button data-item="8">8</button>
    <button data-item="9">9</button>
    <button data-item="10">10</button>
  </div>

  <div id="main">
    <div id="canvasWrapper">
      <canvas id="canvas"></canvas>
    </div>
    <div id="list">
      <h3>標記品項清單</h3>
      <table id="itemTable">
        <thead>
          <tr>
            <th>品項</th>
            <th>品名</th>
            <th>金額</th>
            <th>數量</th>
            <th>小計</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="4">總金額</td>
            <td id="totalCell">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const imageUpload = document.getElementById("imageUpload");
    const tableBody = document.querySelector("#itemTable tbody");
    const totalCell = document.getElementById("totalCell");
    const itemButtons = document.querySelectorAll("#itemSelector button");
    const wrapper = document.getElementById("canvasWrapper");

    let img = new Image();
    let originalImage = null;
    let marks = [];
    let scale = 1;
    let currentItem = 1;

    const itemColors = [
      "rgba(255, 0, 0, 0.6)", "rgba(0, 128, 0, 0.6)", "rgba(0, 0, 255, 0.6)",
      "rgba(255, 165, 0, 0.6)", "rgba(128, 0, 128, 0.6)", "rgba(0, 255, 255, 0.6)",
      "rgba(255, 255, 0, 0.6)", "rgba(165, 42, 42, 0.6)", "rgba(255, 192, 203, 0.6)", "rgba(128, 128, 128, 0.6)"
    ];

    itemButtons.forEach(button => {
      const item = parseInt(button.dataset.item);
      button.style.backgroundColor = itemColors[item - 1];
      button.addEventListener("click", () => {
        itemButtons.forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");
        currentItem = item;
      });
    });

    imageUpload.addEventListener("change", e => handleFileUpload(e.target.files[0]));
    document.addEventListener("dragover", e => { e.preventDefault(); e.dataTransfer.dropEffect = "copy"; });
    document.addEventListener("drop", e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file) handleFileUpload(file);
    });

    function handleFileUpload(file) {
      const reader = new FileReader();
      reader.onload = function (evt) {
        img.onload = () => {
          originalImage = new Image();
          originalImage.src = img.src;

          scale = Math.min(1, 1000 / img.width, 1000 / img.height);
          const displayWidth = img.width * scale;
          const displayHeight = img.height * scale;

          canvas.width = displayWidth;
          canvas.height = displayHeight;

          // ✅ 動態調整 wrapper 大小
          wrapper.style.width = `${displayWidth}px`;
          wrapper.style.height = `${displayHeight}px`;

          marks = [];
          tableBody.innerHTML = "";
          totalCell.textContent = "0";
          drawImage();
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    }

    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / scale;
      const y = (e.clientY - rect.top) / scale;

      const markIndex = marks.findIndex(mark => {
        const dx = x - mark.x;
        const dy = y - mark.y;
        return Math.sqrt(dx * dx + dy * dy) < 12 / scale;
      });

      if (markIndex >= 0) {
        marks.splice(markIndex, 1);
      } else {
        marks.push({ item: currentItem, x, y });
      }

      updateTable();
      drawImage();
    });

    function drawImage() {
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
      redrawMarks();
    }
